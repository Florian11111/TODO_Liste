<!DOCTYPE html>
<html>
<head>
    <title>API Anfrage</title>
</head>
<body>
    <h1>API Anfrage</h1>
    <button onclick="alleAufgaben()">API Anfrage senden</button>
    <p id="response"></p>
    <div id="output"></div>

    <ul id="taskList" class="task-list1">
        <!-- The tasks will be added dynamically using JavaScript -->
    </ul>
    <h1>----------------------------------------------------</h1>
    <ul id="taskListFertig" class="task-list2">
        <!-- The tasks will be added dynamically using JavaScript -->
    </ul>

    <style>
        .task-list1 {
            color: aqua;
        }
        .task-list2 {
            color: red;
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script> <!-- für websocket -->
    <script src="config.js"></script> <!-- in diesem skript wird der "secretKey gespeichert" -->
    <script>
        // speichert alle tasks
        let aufgabenListe = [];

        function alleAufgaben() {
            fetch(apiUrl + '/api/alleTask', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + secretKey
                }
            })
            .then(response => response.json())
            .then(data => {   
                aufgabenListe = data; 
                document.getElementById("taskList").innerHTML = "";
                document.getElementById("taskListFertig").innerHTML = "";
                aufgabenListe.forEach((task, index) => {
                    const listItem = createListItem(index);
                    if (task.checkt === 0) {
                        taskList.appendChild(listItem);
                    } else {
                        taskListFertig.appendChild(listItem);
                    }
                });
            })
            .catch(error => {
                // Zeige eine Fehlermeldung, wenn die Anfrage fehlschlägt
                document.getElementById('response').innerText = 'Fehler beim Abrufen der Daten.';
            });
        }

function createListItem(index) {
    const { id, color, title, description, checkt } = aufgabenListe[index];

    const li = document.createElement("li");
    li.style.backgroundColor = color;

    const strong = document.createElement("strong");
    strong.textContent = title;
    li.appendChild(strong);

    const p = document.createElement("p");
    p.textContent = description;
    li.appendChild(p);

    const button = document.createElement("button");
    button.textContent = "Aktion ausführen";
    button.addEventListener("click", () => handleButtonClick(index, li));
    li.appendChild(button);

    const extraButton = document.createElement("button");
    extraButton.textContent = "Extra";
    extraButton.classList.add("extra-button");
    extraButton.addEventListener("click", () => showButtons(li));
    li.appendChild(extraButton);

    const actionButton1 = document.createElement("button");
    actionButton1.textContent = "Aktion 1";
    actionButton1.style.display = "none"; // Anfangs unsichtbar
    li.appendChild(actionButton1);

    const actionButton2 = document.createElement("button");
    actionButton2.textContent = "Aktion 2";
    actionButton2.style.display = "none"; // Anfangs unsichtbar
    li.appendChild(actionButton2);

    const cancelButton = document.createElement("button");
    cancelButton.textContent = "Abbruch";
    cancelButton.style.display = "none"; // Anfangs unsichtbar
    cancelButton.addEventListener("click", () => hideButtons(li));
    li.appendChild(cancelButton);

    return li;
}

let openListItem = null;
function showButtons(listItem) {
    
    if (openListItem && openListItem !== listItem) {
        hideButtons(openListItem);
    }    
    openListItem = openListItem === listItem ? null : listItem;
    
    const elementsToHide = listItem.querySelectorAll("strong, p, button:not(.extra-button)");
    elementsToHide.forEach(element => {
        element.style.display = "none";
    });

    const actionButtonsToShow = listItem.querySelectorAll("button:nth-of-type(3), button:nth-of-type(4), button:nth-of-type(5)");
    actionButtonsToShow.forEach(button => {
        button.style.display = "block";
    });

    const extraButton = listItem.querySelector(".extra-button");
    extraButton.style.display = "none";
}

function hideButtons(listItem) {
    const elementsToShow = listItem.querySelectorAll("strong, p, button:not(.extra-button)");
    elementsToShow.forEach(element => {
        element.style.display = "block";
    });

    const actionButtonsToHide = listItem.querySelectorAll("button:nth-of-type(3), button:nth-of-type(4), button:nth-of-type(5)");
    actionButtonsToHide.forEach(button => {
        button.style.display = "none";
    });

    const extraButton = listItem.querySelector(".extra-button");
    extraButton.style.display = "block";
}


        function handleButtonClick(index, listItem) {
            const newChecktValue = aufgabenListe[index].checkt === 0 ? 1 : 0;
            if (aufgabenListe[index].checkt === 0) {
                removeListItemFromList(index, taskList)
            } else {
                removeListItemFromList(index, taskListFertig)
            }

            fetch(apiUrl + '/api/aufgabeCheck', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + secretKey,
                    'AufgabenlisteID': aufgabenListe[index].id,
                    'neuerStand': newChecktValue
                }
            })
            .then(response => response.json())
            .then(antwort => {  
                aufgabenListe[index].checkt = antwort.aktuallisiert;
                updateAlleAufgaben();
            })
            .catch(error => {
                document.getElementById('response').innerText = 'Fehler beim Abrufen der Daten.';
                updateAlleAufgaben();
            });
        }

        function removeListItemFromList(index, list) {
            const listItems = list.querySelectorAll("li");
            if (listItems[index]) {
                listItems[index].remove();
            }
        }

        function updateAlleAufgaben() {
            const taskList = document.getElementById("taskList");
            const taskListFertig = document.getElementById("taskListFertig");

            taskList.innerHTML = ""; // Leere die Listen
            taskListFertig.innerHTML = "";

            aufgabenListe.forEach((task, index) => {
                const listItem = createListItem(index);
                if (task.checkt === 0) {
                    taskList.appendChild(listItem);
                } else {
                    taskListFertig.appendChild(listItem);
                }
            });
        }

        var socket;
        
        function connectToSocket() {
            socket = io.connect(apiUrl, {
                query: { token: validToken }
            });

            socket.on('connect', function() {
                console.log('WebSocket connected');
            });

            socket.on('update', function(state) {
                if (state == 1) {
                    console.log("update!")
                    alleAufgaben(); // updatet alle Aufgaben
                }
            });

            /*
            socket.on('message', function(message) {
                console.log(message)
                document.getElementById('output').innerHTML = '<p>' + message + '</p>';
            });

            // Listen for the 'update_notification' event
            socket.on('update_notification', function(data) {
                console.log('Update notification received:', data.message);
                document.getElementById('output').innerHTML = '<p>Update available: ' + data.message + '</p>';
            });
            */
            socket.on('invalid_token', function() {
                console.log('Invalid token. Closing WebSocket connection.');
                socket.close();
            });
        }
        alleAufgaben();
        connectToSocket();
    </script>
</body>
</html>
